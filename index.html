<!DOCTYPE html>
<html data-theme="dark" lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ö–ò–ù–û - –ë–ª–∞–≥–æ–µ–≤–≥—Ä–∞–¥</title>
<link
rel="icon"
href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçø</text></svg>"
/>
<style>
@import url("https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css");
header h1 { text-align: center; font-size: 400%; font-weight: normal; }

.films article { border: 1px solid rgba(0,0,0,0.5); }
.films article.active { border: 2px solid lime; }

.films article a { text-decoration: none; font-weight: bold; }
.films article ul { none; margin: 0; padding: 0; }
.films article li { list-style: none; padding: .25rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
.films article li:last-child { border-bottom: none; }

#modal-details img { float: left; margin: 0 1rem 1rem 0; object-fit: cover; border: 1px solid #000; padding: 2px; }
#modal-details a { text-decoration: none; }
#modal-details footer { clear: both; }

.error { text-align: center; color: var(--pico-del-color); }

footer { text-align: center; font-size: .7rem; padding: 1rem; }
</style>
</head>

<body>
  <header class="container">
    <hgroup class="hero">
      <h1>üçø–ö–ò–ù–û</h1>
    </hgroup>
  </header>

  <main class="container">
    <div aria-busy="true" class="films"></div>
    <dialog id="modal-details">
      <article>
        <h2></h2>
        <p></p>
        <footer>
          <button class="close-modal secondary">Close</button>
        </footer>
      </article>
    </dialog>
  </main>

  <footer>
    <hr>
    <p>by eoinmcg</p>
  </footer>

  <script>
    const API_BASE = 'https://cinemaxbg.com';
    const RT_SEARCH = 'https://rottentomatoes.com/search?search=';

    // State
    let moviesData = {};

    // Initialize
    init();

    async function init() {
      try {
        const html = await fetchTimetable();
        const doc = parseHTML(html);
        const films = extractFilms(doc);
        moviesData = extractMovies(doc);
        
        renderFilms(films);
        setupModal();
      } catch (error) {
        showError('Failed to load cinema data. Please refresh the page.');
        console.error('Init error:', error);
      }
    }

    async function fetchTimetable() {
      const response = await fetch('/timetable');
      if (!response.ok) throw new Error('Failed to fetch timetable');
      return response.text();
    }

    function parseHTML(html) {
      return new DOMParser().parseFromString(html, 'text/html');
    }

    function extractFilms(doc) {
      const films = {};
      const days = doc.querySelectorAll('#days');
      
      days.forEach(day => {
        const dayName = day.textContent.trim().replace(/\s+/g, '-');
        films[dayName] = [];
        
        const table = day.nextElementSibling;
        if (!table) return;
        
        table.querySelectorAll('tr').forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length < 3) return;
          
          films[dayName].push({
            time: cells[0].textContent.trim(),
            title: cells[1].textContent.trim(),
            price: cells[2].textContent.trim(),
          });
        });
      });
      
      return films;
    }

    function extractMovies(doc) {
      const movies = {};
      const descriptions = doc.querySelectorAll('.filmdescr');
      
      descriptions.forEach(desc => {
        const cells = desc.querySelectorAll('td');
        if (cells.length < 2) return;
        
        const imgElement = cells[0].querySelector('img');
        const titleElement = cells[1].querySelector('span.filmtitle');
        
        if (!imgElement || !titleElement) return;
        
        const title = titleElement.textContent.trim();
        const img = imgElement.src
          .replace(window.location.origin, API_BASE)
          .replace(/width=\d+/, 'width=200')
          .replace(/height=\d+/, 'height=287');
        
        const fullText = cells[1].textContent;
        const fullDesc = fullText.replace(title, '').trim();
        
        movies[title] = { title, fullDesc, img };
      });
      
      return movies;
    }

    function renderFilms(films) {
      const container = document.querySelector('.films');
      const today = getTodayKey();
      const todayTimestamp = parseDate(today);
      
      const html = Object.entries(films)
        .filter(([date]) => parseDate(date) >= todayTimestamp)
        .map(([date, showings]) => {
          const isToday = date === today;
          return `
            <article ${isToday ? 'class="active"' : ''}>
              <h2>${date}</h2>
              <ul>
                ${showings.map(show => `
                  <li>
                    <span class="time">${show.time}</span>
                    <a href="#" data-movie="${show.title}">${show.title}</a>
                    <small>${show.price}</small>
                  </li>
                `).join('')}
              </ul>
            </article>
          `;
        })
        .join('');
      
      container.removeAttribute('aria-busy');
      container.innerHTML = html || '<p class="error">No upcoming showings found.</p>';
    }

    function getTodayKey() {
      const date = new Date();
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const day = days[date.getDay()];
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yy = String(date.getFullYear()).slice(-2);
      
      return `${day}-${dd}.${mm}.${yy}`;
    }

    function parseDate(dateKey) {
      const [_, datePart] = dateKey.split('-');
      const [dd, mm, yy] = datePart.split('.');
      return new Date(2000 + parseInt(yy), parseInt(mm) - 1, parseInt(dd)).getTime();
    }

    function setupModal() {
      const modal = document.getElementById('modal-details');
      const container = document.querySelector('.films');
      
      // Delegate click events
      container.addEventListener('click', (e) => {
        if (e.target.dataset.movie) {
          e.preventDefault();
          showMovieDetails(e.target.dataset.movie);
        }
      });
      
      // Close modal handlers
      modal.querySelector('.close-modal').addEventListener('click', () => modal.close());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.close();
      });
    }

    function showMovieDetails(title) {
      const movie = moviesData[title];
      if (!movie) return;
      
      const modal = document.getElementById('modal-details');
      modal.querySelector('h2').textContent = movie.title;
      modal.querySelector('p').innerHTML = `
        <img src="${movie.img}" alt="${movie.title}" width="200" height="287">
        ${movie.desc}
        <br><br>
        <a href="${RT_SEARCH}${encodeURIComponent(movie.title)}" target="_blank" rel="noopener">
          Search Rotten Tomatoes ‚Üí
        </a>
      `;
      
      modal.showModal();
    }

    function showError(message) {
      const container = document.querySelector('.films');
      container.removeAttribute('aria-busy');
      container.innerHTML = `<p class="error">${message}</p>`;
    }
  </script>
</body>
</html>
